<html>
<head>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
	<title>jQuery observer patter</title>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://plugins.jquery.com/files/jquery-watch.js_0.txt"></script>
	<script type="text/javascript" src="jquery.ui.widget.js"></script>
	<script type="text/javascript">
		// Observer module
		$.fn.extend({
			subscribe: function(f) {
				var obj = this.get(0);
				!obj.__listeners__ && (obj.__listeners__ = []);
				obj.__listeners__.push(f);
			},
			unsubscribe: function(fCallback) {
				var obj = this.get(0);
				for (var i = 0, n = obj.__listeners__.length; i < n; i++) {
					if (typeof obj.__listeners__[i]===fCallback) { delete obj.__listeners__[i]; }
				}
			},
			notify: function(o) {
				var obj = this.get(0);
				for (var i = 0, n = obj.__listeners__.length; i < n; i++) {
					obj.__listeners__[i](o);
				}
			}
		});
		
		$.widget("nj.postManager", {			
			options: {
			},
			
			_init: function() {
			},
			
			_create: function() {
			},
			
			onRecieveData: function(o) {
				if ( !arguments.length ) { return $.proxy(arguments.callee,this) ; }
				console.log("MPostManager fetch action!") ;
				this._fetch(o) ;
			},
			
			_fetch : function (o) {
				console.log(o);				
			}
		});
		
		$.widget("nj.thumbManager", {
			options: {
			},
			
			_init: function() {
			},
			
			_create: function() {
			},
			
			onAdd: function(o) {
				if ( !arguments.length ) { return $.proxy(arguments.callee,this) ; }
				var el = $("<li></li>");
				this.element.append(el);
				$.data(el.get(0), "data", o);
				console.log("MPostManager fetch action!") ;				
				this._update();
			},
			
			onRemove : function () {
				// event callback 
				this._update();
			},

			_update : function() {
				var list = this.element.find("LI");
				var data = [];
				for (var i = 0, n = list.length; i < n; i++) {
					data.push($.data(list[i], "data"));
				}
				this.notify(data) ;
			}
		});		
		
		
		var CImageUploader = function(o) {
			this._init(o) ;
		};
		CImageUploader.prototype = {
			_init : function (o) {		
				this._option = o;
			},
			
			onUpload : function() {
				var o = {
					type : "I_UP",
					src : "http://shai.com/agata.jpg",
					param: this._option
				} ;		
				 $(this).notify(o) ;
			}
		};
		
		var CImageURL = function(o) {
			this._init(o) ;
		};
		CImageURL.prototype = {
			_init : function (o) {		
				this._option = o;
			},
			
			onGetComplete : function() {
				var o = {
					type : "I_URL",
					src : "http://shai.com/agata.jpg",
					param: this._option
				} ;		
				 $(this).notify(o) ;
			}
		};
				
		
		$(function() {
			var oWriteForm = $(".WriteForm").postManager();
			var oEditForm = $(".EditForm").postManager();
		
			oWriteImageUploader = new CImageUploader("hoge");
			oEditImageUploader = new CImageUploader("foo");
			oWriteImageURL = new CImageURL("url_hoge");
			oEditImageURL = new CImageURL("url_foo");
			
			// watch!
			$(oWriteImageUploader).subscribe(WriteForm.postManager("onRecieveData"));
			$(oEditImageUploader).subscribe(EditForm.postManager("onRecieveData"));		
			$(oWriteImageURL).subscribe(WriteForm.postManager("onRecieveData"));
			$(oEditImageURL).subscribe(EditForm.postManager("onRecieveData"));
			
		});
	</script>
</head>
<body>
	<a href="#" onclick="oWriteImageUploader.onUpload() ;">upload1</a>
	<a href="#" onclick="oEditImageUploader.onUpload() ;">upload2</a>
	<a href="#" onclick="oWriteImageURL.onGetComplete() ;">upload1</a>
	<a href="#" onclick="oEditImageURL.onGetComplete() ;">upload2</a>
	<div class="WriteForm">WriteForm</div>
	<div class="EditForm">EditForm</div>
</body>
</html>